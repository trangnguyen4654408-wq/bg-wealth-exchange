<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BG Pro V24 - Native Fix</title>

    <link rel="manifest" id="my-manifest">
    <script>
        const manifest = { "name": "BG Pro", "short_name": "BG Pro", "start_url": ".", "display": "standalone", "background_color": "#12161c", "theme_color": "#1e2329", "icons": [{ "src": "https://bin.bnbstatic.com/static/images/common/favicon.ico", "sizes": "192x192", "type": "image/png" }] };
        document.querySelector('#my-manifest').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/toast.css">
</head>
<body>

    <div id="view-home" class="view-section active">
        <div class="app-header">
            <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                <img src="https://bin.bnbstatic.com/static/images/common/favicon.ico" class="app-logo" style="width:30px;height:30px;" onclick="window.location.reload()">
                <div>
                    <span id="user-name-home">Guest</span>
                </div>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i class="fas fa-bell" style="font-size:20px;" onclick="openNoti()"></i>
                <i class="fas fa-user-circle" style="font-size:24px; color:var(--text-primary);" onclick="openProfile()"></i>
            </div>
        </div>
        <div class="asset-card">
            <div style="font-size:12px;">Tổng tài sản (USDT)</div>
            <div class="total-balance" id="home-total">0.00 $</div>
            <div style="font-size:12px;">Lãi/Lỗ: <span id="home-pnl-val" style="font-weight:bold;">0.00 $</span></div>
        </div>
        <div class="quick-actions">
            <div class="action-btn" onclick="fakeAction('Nạp')"><i class="fas fa-arrow-down"></i>Nạp</div>
            <div class="action-btn" onclick="fakeAction('Rút')"><i class="fas fa-arrow-up"></i>Rút</div>
            <div class="action-btn" onclick="showToast('Tính năng đang bảo trì', 'info')"><i class="fas fa-exchange-alt"></i>Chuyển</div>
            <div class="action-btn" onclick="switchTab('assets', 3)"><i class="fas fa-history"></i>Lịch sử</div>
        </div>
        <div id="home-list" style="padding-bottom: 20px;"></div>
    </div>

    <div id="view-markets" class="view-section">
        <div class="app-header">Thị trường <i class="fas fa-search" style="float:right"></i></div>
        <div id="market-full-list"></div>
    </div>

    <div id="view-trade" class="view-section">
        <div class="app-header">
            <div onclick="openCoinMenu()" style="font-size:18px; font-weight:bold;"><i class="fas fa-bars"></i> <span id="trade-pair">BTC/USDT</span> <span id="trade-change" style="font-size:12px;">+0.00%</span></div>
            <div onclick="toggleChart()" style="font-size:12px; padding:6px 12px; background:#333; border-radius:4px;"><i class="fas fa-chart-line"></i> Chart</div>
        </div>
        <div id="chart-container"></div>
        <div class="trade-layout">
            <div class="col-left">
                <div style="display:flex; justify-content:space-between; padding:0 5px; font-size:10px; color:var(--text-secondary);"><span>Giá</span><span>SL</span></div>
                <div id="asks-box" style="flex:1; display:flex; flex-direction:column-reverse; overflow:hidden;"></div>
                <div style="text-align:center; font-size:18px; font-weight:700; color:var(--green); padding:8px 0;" id="trade-price">---</div>
                <div id="bids-box" style="flex:1; overflow:hidden;"></div>
            </div>
            <div class="col-right">
                <div style="display:flex; gap:10px;">
                    <div class="type-btn active-buy" id="btn-buy" onclick="setTradeMode('buy')">Mua</div>
                    <div class="type-btn" id="btn-sell" onclick="setTradeMode('sell')">Bán</div>
                </div>
                <div style="margin-top:10px;"><input type="text" id="inp-price" class="input-box" readonly placeholder="Giá"></div>
                <div style="margin-top:10px;"><input type="number" id="inp-amt" class="input-box" placeholder="Số lượng" oninput="calcTotal()"></div>
                <div style="margin-top:5px; font-size:11px; text-align:right;">Phí (0.1%): <span id="trade-fee" style="color:var(--text-secondary);">0.00 $</span></div>
                <div style="margin-top:2px; font-size:11px; text-align:right;">Tổng: <span id="trade-total" style="color:white; font-weight:bold;">0.00 $</span></div>
                <div style="font-size:12px; text-align:right; margin-top:10px; color:#888;">Khả dụng: <span id="avail-trade" style="color:var(--gold); font-weight:bold;">---</span></div>
                <button class="btn-action" id="btn-action" style="background:var(--green)" onclick="doTrade()">MUA NGAY</button>
            </div>
        </div>
    </div>

    <div id="view-assets" class="view-section">
        <div class="app-header">Ví của tôi</div>
        <div class="asset-card">
            <div style="font-size:12px;">Tổng giá trị ước tính</div>
            <div class="total-balance" id="asset-total">0.00 $</div>
        </div>
        <div class="quick-actions">
            <div class="action-btn" onclick="fakeAction('Nạp')"><i class="fas fa-arrow-down"></i>Nạp</div>
            <div class="action-btn" onclick="fakeAction('Rút')"><i class="fas fa-arrow-up"></i>Rút</div>
            <div class="action-btn" onclick="showToast('Tính năng đang bảo trì', 'info')"><i class="fas fa-exchange-alt"></i>Chuyển</div>
            <div class="action-btn" onclick="window.location.reload()"><i class="fas fa-sync-alt"></i>Reset</div>
        </div>
        <div id="asset-list"></div>
    </div>

    <div id="user-modal" onclick="openProfile()">
        <div class="profile-content" onclick="event.stopPropagation()">
            <div style="text-align:center;margin-bottom:20px;">
                <i class="fas fa-user-circle" style="font-size:60px;color:#fcd535"></i>
                <div id="modal-email" style="font-weight:bold;margin-top:10px;">...</div>
                <div id="kyc-badge-modal" style="margin-top:10px;">
                    <button onclick="verifyIdentity()" id="btn-kyc" style="background:#333; border:1px solid #555; color:white; padding:5px 10px; border-radius:4px;">Xác minh danh tính (KYC)</button>
                </div>
            </div>
            <script>
    // 1. CẤU HÌNH SỐ DƯ (Lấy từ Login hoặc mặc định)
    // Đây là nơi anh chỉnh số coin anh muốn hiển thị
    const myWallet = {
        USDT: 10000.00,
        BTC: 0.5,
        ETH: 2.0
    };

    // 2. KẾT NỐI WEBSOCKET BINANCE (Lấy giá siêu nhanh)
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');

    // Biến lưu giá hiện tại
    let currentPrices = {
        BTCUSDT: 0,
        ETHUSDT: 0
    };

    // Khi có dữ liệu mới từ sàn trả về
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        // Lọc lấy giá BTC và ETH
        data.forEach(ticker => {
            if (ticker.s === 'BTCUSDT') currentPrices.BTCUSDT = parseFloat(ticker.c);
            if (ticker.s === 'ETHUSDT') currentPrices.ETHUSDT = parseFloat(ticker.c);
        });

        // Cập nhật giao diện ngay lập tức
        updateUI();
    };

    // 3. HÀM TÍNH TOÁN VÀ HIỂN THỊ (Logic fix lỗi lệch giá)
    function updateUI() {
        // Nếu chưa có giá thì chưa tính
        if (currentPrices.BTCUSDT === 0) return;

        // Tính giá trị từng coin
        const btcVal = myWallet.BTC * currentPrices.BTCUSDT;
        const ethVal = myWallet.ETH * currentPrices.ETHUSDT;
        const totalVal = myWallet.USDT + btcVal + ethVal;

        // Hiển thị số dư Coin
        document.getElementById('btc-balance').innerText = myWallet.BTC.toFixed(4);
        document.getElementById('eth-balance').innerText = myWallet.ETH.toFixed(4);

        // Hiển thị giá trị quy đổi ($) - FIX LỖI 0.00 $
        document.getElementById('btc-value').innerText = `$${btcVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('eth-value').innerText = `$${ethVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

        // Hiển thị TỔNG TÀI SẢN (Số to đùng màu vàng)
        document.getElementById('total-balance').innerText = `$${totalVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        
        // Cập nhật luôn title trang web cho chuyên nghiệp
        document.title = `BTC: $${currentPrices.BTCUSDT} | BG WEALTH`;
    }

    // 4. FIX BIỂU ĐỒ (TradingView Widget)
    // Tự động chèn biểu đồ vào khung nếu đang bị đen
    function initChart() {
        const chartContainer = document.querySelector('.chart-area') || document.getElementById('chart-container');
        if (chartContainer) {
            chartContainer.innerHTML = ''; // Xóa cái khung đen cũ đi
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.onload = () => {
                new TradingView.widget({
                    "width": "100%",
                    "height": 400,
                    "symbol": "BINANCE:BTCUSDT",
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "vi_VN",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "container_id": chartContainer.id || "tradingview_chart"
                });
            };
            document.head.appendChild(script);
        }
    }

    // Chạy fix biểu đồ sau 1 giây
    setTimeout(initChart, 1000);

</script>
        <div class="nav-item" onclick="switchTab('trade', 2)"><i class="fas fa-exchange-alt"></i></div>
        <div class="nav-item" onclick="switchTab('assets', 3)"><i class="fas fa-wallet"></i></div>
    </div>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="js/ui.js"></script>
    <script type="module" src="js/app.js"></script>
</body>
</html>
